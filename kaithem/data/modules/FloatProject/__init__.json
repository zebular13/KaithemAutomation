{
    "action": "module.timedisplay.write(kaithem.string.formatTimeInterval(module.timeremaining(),3))\r\nmodule.statusdisplay.write(module.status)\r\nmodule.modedisplay.write(module.mode)",
    "continual": true,
    "disabled": false,
    "once": true,
    "priority": "interactive",
    "rate-limit": 0.1,
    "resource-type": "event",
    "setup": "import time\r\n\r\nmodule.status = \"Ready\"\r\n\r\nmodule.sessionlen = 3600\r\nmodule.showerlen = 10*60\r\nmodule.postshowerlen = 15*60\r\nmodule.tank_exit_wait = 2*60\r\n\r\nmodule.stagestart = 0\r\nmodule.stagelen = 0\r\n\r\ndef timeremaining():\r\n    return max(0,module.stagelen-(time.time()-module.stagestart))\r\ndef stagetime():\r\n    return max(0,time.time()-module.stagestart)\r\n\r\nmodule.r = kaithem.widget.Slider(min=0,max=255,step=1)\r\nmodule.g =kaithem.widget.Slider(min=0,max=255,step=1)\r\nmodule.b =kaithem.widget.Slider(min=0,max=255,step=1)\r\n\r\ndef f(u,v):\r\n    if u==\"__SERVER__\":\r\n        return\r\n    else:\r\n        module.mode = \"custom\"\r\nmodule.r.attach(f)\r\nmodule.g.attach(f)\r\nmodule.b.attach(f)\r\n\r\n                            \r\n\r\nmodule.timeremaining = timeremaining\r\n\r\nmodule.stagetime = stagetime\r\nmodule.statusdisplay = kaithem.widget.DynamicSpan()\r\nmodule.modedisplay = kaithem.widget.DynamicSpan()\r\n\r\nmodule.outputen = kaithem.widget.Switch()\r\nmodule.paleness = kaithem.widget.Slider(min=0,max=1,step=0.1)\r\nmodule.volume = kaithem.widget.Slider(min=0,max=1,step=0.1)\r\nmodule.soundreactive = kaithem.widget.Slider(min=0,max=1,step=0.1)\r\nmodule.fade = kaithem.widget.Slider(min=0.8,max=1,step=0.0025)\r\nmodule.thresh = kaithem.widget.Slider(min=0,max=1.8,step=0.1)\r\nmodule.start = kaithem.widget.Button()\r\nmodule.startshort = kaithem.widget.Button()\r\nmodule.forcestart = kaithem.widget.Button()\r\nmodule.forceend = kaithem.widget.Button()\r\nmodule.forceendpostsession = kaithem.widget.Button()\r\n\r\n\r\nmodule.timedisplay = kaithem.widget.DynamicSpan();\r\nmodule.fadeout = kaithem.widget.Slider(min=0, max=300, step=10)\r\nmodule.fadein = kaithem.widget.Slider(min=0, max=300, step=10)\r\nmodule.lightsduring = kaithem.widget.Switch()\r\nmodule.halfwaylight = kaithem.widget.Switch()\r\nmodule.peak = kaithem.widget.Meter(min=0,max=1)\r\nmodule.mode = 'red'\r\nmodule.sessionstart = 0;\r\n\r\n\r\ndef f(u,v):\r\n    if not \"pushed\" in v:\r\n        return\r\n    module.stagelen = 0\r\nmodule.forceend.attach(f)\r\n\r\ndef f(u,v):\r\n    if not \"pushed\" in v:\r\n        return\r\n    if not( module.status == \"Post-Session\"  or module.status == \"Waiting for client to exit tank\"):\r\n        return\r\n    module.stagestart = 0\r\nmodule.forceendpostsession.attach(f)\r\n\r\ndef f(u,v):\r\n    kaithem.sys.shellex(\"amixer sset 'Master' \" + str(int(module.volume.read()*100)) + \"%\")\r\nmodule.volume.attach(f)\r\n\r\ndef f(u,v):\r\n    if not \"pushed\" in v:\r\n        return\r\n    if not module.status == \"Presession\":\r\n        return\r\n    module.status = \"In Session\"\r\n    module.stagelen = module.sessionlen\r\n    module.sessionstart = time.time()\r\nmodule.forcestart.attach(f)\r\n\r\n\r\ndef f(u,v):\r\n    if not \"pushed\" in v:\r\n        return\r\n    if not module.status == \"Ready\":\r\n        return\r\n    module.stagestart = time.time()\r\n    module.status = \"Presession\"\r\n    module.stagelen = module.showerlen\r\n    module.sessionlen = 3600\r\nmodule.start.attach(f)\r\n\r\ndef f(u,v):\r\n    if not \"pushed\" in v:\r\n        return\r\n    if not module.status == \"Ready\":\r\n        return\r\n    module.status = \"Presession\"\r\n    module.stagelen = module.showerlen\r\n    module.stagestart = time.time()\r\n    module.sessionlen = 60\r\nmodule.startshort.attach(f)\r\n\r\ndef f(u,v):\r\n    module.s.send(b'thresh',[int(128*v)])\r\nmodule.thresh.attach(f)\r\n\r\ndef f(u,v):\r\n    module.s.send(b'fade',[int(255*v)])\r\nmodule.fade.attach(f)\r\n\r\ndef f(u,v):\r\n    kaithem.message.post(\"MainTank_beat\",v)\r\nmodule.soundreactive.attach(f)\r\n",
    "trigger": "True",
    "versions": {
        "action": "module.timedisplay.write(kaithem.string.formatTimeInterval(module.timeremaining(),3))\r\nmodule.statusdisplay.write(module.status)\r\nmodule.modedisplay.write(module.mode)",
        "continual": true,
        "priority": "interactive",
        "rate-limit": 0.1,
        "resource-type": "event",
        "setup": "import time\r\n\r\nmodule.status = \"Ready\"\r\n\r\nmodule.sessionlen = 3600\r\nmodule.showerlen = 10*60\r\nmodule.postshowerlen = 15*60\r\n\r\nmodule.stagestart = 0\r\n\r\ndef timeremaining():\r\n    return max(0,module.sessionlen-(time.time()-module.stagestart))\r\ndef stagetime():\r\n    return max(0,time.time()-module.stagestart)\r\n\r\nmodule.r = kaithem.widget.Slider(min=0,max=255,step=1)\r\nmodule.g =kaithem.widget.Slider(min=0,max=255,step=1)\r\nmodule.b =kaithem.widget.Slider(min=0,max=255,step=1)\r\n\r\ndef f(u,v):\r\n    if u==\"__SERVER__\":\r\n        return\r\n    else:\r\n        module.mode = \"custom\"\r\nmodule.r.attach(f)\r\nmodule.g.attach(f)\r\nmodule.b.attach(f)\r\n\r\n                            \r\n\r\nmodule.timeremaining = timeremaining\r\n\r\nmodule.stagetime = stagetime\r\nmodule.statusdisplay = kaithem.widget.DynamicSpan()\r\nmodule.modedisplay = kaithem.widget.DynamicSpan()\r\n\r\nmodule.outputen = kaithem.widget.Switch()\r\nmodule.paleness = kaithem.widget.Slider(min=0,max=1,step=0.1)\r\nmodule.volume = kaithem.widget.Slider(min=0,max=1,step=0.1)\r\nmodule.soundreactive = kaithem.widget.Slider(min=0,max=1,step=0.1)\r\nmodule.fade = kaithem.widget.Slider(min=0.8,max=1,step=0.0025)\r\nmodule.thresh = kaithem.widget.Slider(min=0,max=1.8,step=0.1)\r\nmodule.start = kaithem.widget.Button()\r\nmodule.startshort = kaithem.widget.Button()\r\nmodule.forcestart = kaithem.widget.Button()\r\nmodule.forceend = kaithem.widget.Button()\r\nmodule.forceendpostsession = kaithem.widget.Button()\r\n\r\n\r\nmodule.timedisplay = kaithem.widget.DynamicSpan();\r\nmodule.fadeout = kaithem.widget.Slider(min=0, max=300, step=10)\r\nmodule.fadein = kaithem.widget.Slider(min=0, max=300, step=10)\r\nmodule.lightsduring = kaithem.widget.Switch()\r\nmodule.halfwaylight = kaithem.widget.Switch()\r\nmodule.peak = kaithem.widget.Meter(min=0,max=1)\r\nmodule.mode = 'red'\r\nmodule.sessionstart = 0;\r\n\r\n\r\ndef f(u,v):\r\n    if not \"pushed\" in v:\r\n        return\r\n    module.sessionlen = 0\r\nmodule.forceend.attach(f)\r\n\r\ndef f(u,v):\r\n    if not \"pushed\" in v:\r\n        return\r\n    if not module.status == \"Post-Session\":\r\n        return\r\n    module.stagestart = 0\r\nmodule.forceendpostsession.attach(f)\r\n\r\ndef f(u,v):\r\n    kaithem.sys.shellex(\"amixer sset 'Master' \" + str(int(module.volume.read()*100)) + \"%\")\r\nmodule.volume.attach(f)\r\n\r\ndef f(u,v):\r\n    if not \"pushed\" in v:\r\n        return\r\n    if not( module.status == \"Presession\" or module.status == \"Waiting for client to exit tank\":\r\n        return\r\n    module.status = \"In Session\"\r\n    module.sessionstart = time.time()\r\nmodule.forcestart.attach(f)\r\n\r\n\r\ndef f(u,v):\r\n    if not \"pushed\" in v:\r\n        return\r\n    if not module.status == \"Ready\":\r\n        return\r\n    module.stagestart = time.time()\r\n    module.status = \"Presession\"\r\n    module.sessionlen = 3600\r\nmodule.start.attach(f)\r\n\r\ndef f(u,v):\r\n    if not \"pushed\" in v:\r\n        return\r\n    if not module.status == \"Ready\":\r\n        return\r\n    module.status = \"Presession\"\r\n    module.stagestart = time.time()\r\n    module.sessionlen = 60\r\nmodule.startshort.attach(f)\r\n\r\ndef f(u,v):\r\n    module.s.send(b'thresh',[int(128*v)])\r\nmodule.thresh.attach(f)\r\n\r\ndef f(u,v):\r\n    module.s.send(b'fade',[int(255*v)])\r\nmodule.fade.attach(f)\r\n\r\ndef f(u,v):\r\n    kaithem.message.post(\"MainTank_beat\",v)\r\nmodule.soundreactive.attach(f)\r\n",
        "trigger": "True"
    }
}